name: Build From ALL Zips (Auto Locate ‚Äì macOS Safe)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # 1) Unzip ALL zip files (recursive ‚Äì macOS safe)
      # --------------------------------------------------
      - name: 1) Unzip ALL zip files + show paths
        shell: bash
        run: |
          set -e

          echo "üì¶ Searching for zip files..."
          ZIPS=$(find . -type f -name "*.zip")

          if [ -z "$ZIPS" ]; then
            echo "‚ö†Ô∏è No zip files found."
          else
            echo "‚úÖ Found zip files:"
            echo "$ZIPS"
          fi

          echo "üìÇ Unzipping all archives..."
          for z in $ZIPS; do
            echo "--> Unzipping: $z"
            unzip -o -q "$z"
          done

          echo "üìÅ Files after unzip:"
          ls -la

      # --------------------------------------------------
      # 2) Locate Project Root + deps (KittyMemory)
      # --------------------------------------------------
      - name: 2) Locate Project Root (Makefile) + deps
        shell: bash
        run: |
          set -e

          echo "üîç Searching for Makefile..."
          MAKEFILE_PATH=$(find . -name "Makefile" -not -path "*/theos/*" | head -n 1 || true)

          if [ -z "$MAKEFILE_PATH" ]; then
            echo "‚ùå ERROR: Makefile not found after unzip."
            exit 1
          fi

          PROJECT_ROOT=$(cd "$(dirname "$MAKEFILE_PATH")" && pwd)
          echo "‚úÖ PROJECT_ROOT = $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo "üîç Searching for KittyInclude.hpp..."
          KITTY_FILE=$(find . -name "KittyInclude.hpp" | head -n 1 || true)

          mkdir -p "$PROJECT_ROOT/deps"

          if [ -n "$KITTY_FILE" ]; then
            SOURCE_DIR=$(cd "$(dirname "$KITTY_FILE")" && pwd)
            DEST_DIR="$PROJECT_ROOT/deps/KittyMemory"

            if [ "$SOURCE_DIR" != "$DEST_DIR" ]; then
              echo "üöö Copying KittyMemory to deps..."
              rm -rf "$DEST_DIR"
              mkdir -p "$DEST_DIR"
              cp -R "$SOURCE_DIR"/. "$DEST_DIR"/
            fi
          else
            echo "‚ö†Ô∏è KittyMemory not found ‚Äì cloning fallback..."
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git "$PROJECT_ROOT/deps/KittyMemory"
          fi

          echo "üìå deps content:"
          ls -la "$PROJECT_ROOT/deps"

      # --------------------------------------------------
      # 3) Setup Theos (FIX sdks conflict)
      # --------------------------------------------------
      - name: 3) Setup Theos (clean + safe)
        shell: bash
        run: |
          set -e

          echo "üßπ Cleaning old Theos..."
          rm -rf "$HOME/theos"

          echo "‚¨áÔ∏è Cloning Theos..."
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          if [ -d "$HOME/theos/sdks" ] && [ "$(ls -A "$HOME/theos/sdks" | wc -l | tr -d ' ')" -gt 0 ]; then
            echo "‚úÖ sdks already present"
          else
            echo "‚¨áÔ∏è Cloning sdks..."
            rm -rf "$HOME/theos/sdks"
            git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"
          fi

          echo "üç∫ Installing tools..."
          brew update
          brew install ldid xz || true

      # --------------------------------------------------
      # 4) Build
      # --------------------------------------------------
      - name: 4) Build package
        shell: bash
        run: |
          set -e
          cd "$PROJECT_ROOT"

          echo "üîß Setting include paths..."
          export THEOS="$HOME/theos"
          export THEOS_INCLUDE_PATH="$PWD/deps/KittyMemory"
          export CFLAGS="$CFLAGS -I$PWD/deps/KittyMemory"
          export CXXFLAGS="$CXXFLAGS -I$PWD/deps/KittyMemory"

          echo "üßπ make clean..."
          make clean || true

          echo "üöÄ make package..."
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="-I$PWD/deps/KittyMemory" \
            ADDITIONAL_CCFLAGS="-I$PWD/deps/KittyMemory"

          echo "üì¶ Packages:"
          ls -la "$PROJECT_ROOT/packages"

      # --------------------------------------------------
      # 5) Upload DEB
      # --------------------------------------------------
      - name: 5) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: Final_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
          if-no-files-found: error
