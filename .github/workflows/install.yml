name: Build From Zips (Auto-Discover + Fix Paths)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1) Unzip ALL zip files (recursive) + show paths
        shell: bash
        run: |
          set -euo pipefail

          echo "üîé Searching for zip files (recursive)..."
          mkdir -p _extract

          # ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÉŸÑ zip ÿØÿßÿÆŸÑ ÿßŸÑÿ±Ÿäÿ®Ÿà (ÿ≠ÿ™Ÿâ ŸÑŸà ÿØÿßÿÆŸÑ ŸÖÿ¨ŸÑÿØ)
          find . -type f -name "*.zip" -print0 | while IFS= read -r -d '' z; do
            echo "üì¶ Unzipping: $z"
            unzip -o -q "$z" -d _extract
          done

          echo "‚úÖ Done unzipping."
          echo "üìÇ Top of _extract:"
          ls -la _extract || true

          echo "üßæ Show some extracted structure (depth 4):"
          find _extract -maxdepth 4 -type d -print | sed 's|^| - |' | head -n 200

      - name: 2) Locate PROJECT_ROOT (Makefile) + locate deps (KittyMemory) + locate sources
        shell: bash
        run: |
          set -euo pipefail

          echo "üîç Searching for Makefile inside _extract..."
          MAKEFILE_PATH="$(find _extract -type f -name "Makefile" | head -n 1 || true)"

          if [[ -z "${MAKEFILE_PATH}" ]]; then
            echo "‚ùå ERROR: Makefile not found in extracted content."
            echo "   Show Makefile candidates:"
            find _extract -type f -iname "*makefile*" -maxdepth 8 -print || true
            exit 1
          fi

          PROJECT_ROOT="$(dirname "$MAKEFILE_PATH")"
          echo "‚úÖ PROJECT_ROOT=$PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo ""
          echo "üîç Searching for KittyInclude.hpp inside _extract..."
          KITTY_HEADER="$(find _extract -type f -name "KittyInclude.hpp" | head -n 1 || true)"

          if [[ -n "${KITTY_HEADER}" ]]; then
            KITTY_INC_DIR="$(dirname "$KITTY_HEADER")"
            KITTY_BASE_DIR="$(cd "$KITTY_INC_DIR/.." && pwd 2>/dev/null || true)"
            echo "‚úÖ Found KittyInclude.hpp at: $KITTY_HEADER"
            echo "‚úÖ KITTY_INC_DIR=$KITTY_INC_DIR"
            echo "‚úÖ KITTY_BASE_DIR=$KITTY_BASE_DIR"
            echo "KITTY_INC_DIR=$KITTY_INC_DIR" >> "$GITHUB_ENV"
            echo "KITTY_BASE_DIR=$KITTY_BASE_DIR" >> "$GITHUB_ENV"
          else
            echo "‚ö†Ô∏è KittyInclude.hpp not found in zips. Will clone KittyMemory as fallback."
            echo "KITTY_INC_DIR=" >> "$GITHUB_ENV"
            echo "KITTY_BASE_DIR=" >> "$GITHUB_ENV"
          fi

          echo ""
          echo "üîé Quick sanity: show PROJECT_ROOT files:"
          ls -la "$PROJECT_ROOT" || true

          echo ""
          echo "üîé Find .mm/.xm/.m sources near PROJECT_ROOT (for Tweak.mm issue):"
          find "$PROJECT_ROOT" -maxdepth 4 -type f \( -name "*.mm" -o -name "*.xm" -o -name "*.m" -o -name "*.cpp" -o -name "*.hpp" -o -name "*.h" \) | head -n 120 || true

      - name: 3) Setup Theos (clean) + FIX sdks conflict
        shell: bash
        run: |
          set -euo pipefail

          echo "üßπ Cleaning previous theos..."
          rm -rf "$HOME/theos"

          echo "‚¨áÔ∏è Cloning theos..."
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          echo "üßπ Remove any existing sdks to avoid 'already exists'..."
          rm -rf "$HOME/theos/sdks"

          echo "‚¨áÔ∏è Cloning sdks..."
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          echo "üßπ Optional: remove old sdks to reduce size"
          rm -rf "$HOME/theos/sdks/iPhoneOS9.0.sdk" || true
          rm -rf "$HOME/theos/sdks/iPhoneOS10.0.sdk" || true
          rm -rf "$HOME/theos/sdks/iPhoneOS11.0.sdk" || true
          rm -rf "$HOME/theos/sdks/iPhoneOS12.0.sdk" || true
          rm -rf "$HOME/theos/sdks/iPhoneOS13.0.sdk" || true

          echo "üç∫ Installing build tools..."
          brew update
          brew install ldid xz make fmt

          echo "‚úÖ Theos installed at: $HOME/theos"
          ls -la "$HOME/theos" | head -n 30 || true
          echo "‚úÖ SDKs:"
          ls -la "$HOME/theos/sdks" | head -n 50 || true

      - name: 3.1) Ensure KittyMemory exists (fallback clone)
        shell: bash
        run: |
          set -euo pipefail

          cd "${{ env.PROJECT_ROOT }}"

          if [[ -z "${{ env.KITTY_INC_DIR }}" ]]; then
            echo "‚¨áÔ∏è Cloning KittyMemory fallback into PROJECT_ROOT/deps/KittyMemory ..."
            mkdir -p deps
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory

            # Try to locate KittyInclude.hpp again
            KITTY_HEADER="$(find deps/KittyMemory -type f -name "KittyInclude.hpp" | head -n 1 || true)"
            if [[ -z "$KITTY_HEADER" ]]; then
              echo "‚ùå ERROR: KittyInclude.hpp still not found after clone."
              exit 1
            fi

            KITTY_INC_DIR="$(dirname "$KITTY_HEADER")"
            KITTY_BASE_DIR="$(cd "$KITTY_INC_DIR/.." && pwd 2>/dev/null || true)"

            echo "‚úÖ Found KittyInclude.hpp at: $KITTY_HEADER"
            echo "‚úÖ KITTY_INC_DIR=$KITTY_INC_DIR"
            echo "‚úÖ KITTY_BASE_DIR=$KITTY_BASE_DIR"

            echo "KITTY_INC_DIR=$KITTY_INC_DIR" >> "$GITHUB_ENV"
            echo "KITTY_BASE_DIR=$KITTY_BASE_DIR" >> "$GITHUB_ENV"
          else
            echo "‚úÖ KittyMemory already found from zips."
          fi

      - name: 4) Build (auto include paths for KittyMemory + fmt)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ env.PROJECT_ROOT }}"

          echo "üß† Using PROJECT_ROOT: $PWD"
          echo "üìå KITTY_INC_DIR: ${{ env.KITTY_INC_DIR }}"
          echo "üìå KITTY_BASE_DIR: ${{ env.KITTY_BASE_DIR }}"

          # fmt paths
          FMT_PREFIX="$(brew --prefix fmt)"
          echo "üìå FMT_PREFIX: $FMT_PREFIX"

          # Includes:
          # - Kitty include dir (where KittyInclude.hpp exists)
          # - Kitty base dir (sometimes headers are referenced relative)
          # - fmt include
          INC_FLAGS=""
          if [[ -n "${{ env.KITTY_INC_DIR }}" ]]; then
            INC_FLAGS="$INC_FLAGS -I${{ env.KITTY_INC_DIR }} -I${{ env.KITTY_BASE_DIR }}"
          fi
          INC_FLAGS="$INC_FLAGS -I$FMT_PREFIX/include"

          # Link fmt (ÿ≠ŸÑ ŸÖÿ¥ŸÉŸÑÿ© ld: symbols not found ÿßŸÑŸÖÿ™ÿπŸÑŸÇÿ© ÿ®ŸÄ fmt)
          LIB_FLAGS="-L$FMT_PREFIX/lib -lfmt"

          echo "‚úÖ INC_FLAGS=$INC_FLAGS"
          echo "‚úÖ LIB_FLAGS=$LIB_FLAGS"

          make clean || true

          # ŸÜŸÖÿ±ÿ± ÿßŸÑŸÅŸÑÿßŸÇÿ≤ ŸÖÿ®ÿßÿ¥ÿ±ÿ©
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="$INC_FLAGS" \
            ADDITIONAL_CCFLAGS="$INC_FLAGS" \
            ADDITIONAL_CXXFLAGS="$INC_FLAGS" \
            ADDITIONAL_LDFLAGS="$LIB_FLAGS"

      - name: 5) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: Deb_Output
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
            ${{ env.PROJECT_ROOT }}/.theos/obj/**/*.log
