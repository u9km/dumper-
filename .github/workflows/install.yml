name: Ultimate Build (Auto-Gen Makefile)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------------
      # 1. ÙÙƒ Ø¶ØºØ· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Tweak, deps, scripts, main) ÙÙŠ Ø³Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
      # ------------------------------------------------------------------
      - name: 1) Unzip All Files
        shell: bash
        run: |
          set -e
          echo "ğŸ“¦ Unzipping all zip files..."
          rm -rf _extract
          mkdir -p _extract

          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ù…Ù„Ù zip ÙˆÙÙƒ Ø¶ØºØ·Ù‡
          find . -maxdepth 1 -name "*.zip" -exec unzip -o -q {} -d _extract \;

          echo "âœ… Extracted files tree:"
          find _extract -maxdepth 2 -type d

      # ------------------------------------------------------------------
      # 2. ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      # ------------------------------------------------------------------
      - name: 2) Locate Project Root
        shell: bash
        run: |
          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù„Ù ÙƒÙˆØ¯ Ø£Ø³Ø§Ø³ÙŠ (Ù…Ø«Ù„ Tweak.xm Ø£Ùˆ Dumper.cpp)
          SRC_FILE=$(find _extract -name "Tweak.mm" -o -name "Tweak.xm" -o -name "Dumper.cpp" | head -n 1)

          if [ -z "$SRC_FILE" ]; then
            echo "âŒ Error: No source code found in zips!"
            exit 1
          fi

          PROJECT_ROOT=$(dirname "$SRC_FILE")
          # ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ src
          if [[ $(basename "$PROJECT_ROOT") == "src" ]]; then
            PROJECT_ROOT=$(dirname "$PROJECT_ROOT")
          fi

          echo "âœ… Project Root: $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV

      # ------------------------------------------------------------------
      # 3. Ø¥ØµÙ„Ø§Ø­ Ù…ÙƒØ§Ù† KittyMemory (Ù†Ù‚Ù„Ù‡Ø§ Ù„Ø¯Ø§Ø®Ù„ deps)
      # ------------------------------------------------------------------
      - name: 3) Fix KittyMemory
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          mkdir -p deps

          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ÙƒØªØ¨Ø©
          KITTY_FILE=$(find ../.. -name "KittyInclude.hpp" | head -n 1)

          if [ -n "$KITTY_FILE" ]; then
            echo "âœ… Found KittyInclude at: $KITTY_FILE"
            KITTY_DIR=$(dirname "$KITTY_FILE")
            
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø³Ø® Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµØ­ÙŠØ­
            if [[ $(basename "$KITTY_DIR") == "KittyMemory" ]]; then
               CP_SOURCE="$KITTY_DIR"
            else
               CP_SOURCE="$KITTY_DIR"
            fi
            
            # ØªÙ†Ø¸ÙŠÙ ÙˆÙ†Ø³Ø®
            rm -rf deps/KittyMemory
            mkdir -p deps/KittyMemory
            cp -R "$CP_SOURCE/" deps/KittyMemory/
            
            echo "KITTY_PATH=$PROJECT_ROOT/deps/KittyMemory" >> $GITHUB_ENV
          else
            echo "âš ï¸ KittyMemory not found, cloning from git..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
            echo "KITTY_PATH=$PROJECT_ROOT/deps/KittyMemory" >> $GITHUB_ENV
          fi

      # ------------------------------------------------------------------
      # 4. Ø¥Ù†Ø´Ø§Ø¡ Makefile Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©)
      # ------------------------------------------------------------------
      - name: 4) Generate Fresh Makefile
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          
          echo "ğŸ—‘ï¸ Deleting old broken Makefile..."
          rm -f Makefile

          echo "ğŸ†• Generating smart Makefile..."
          # Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ³ØªØ®Ø¯Ù… wildcard Ù„ÙŠØ¬Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙ‚Ø·
          # ÙˆÙŠØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ù…Ù„Ù Ù…ÙÙ‚ÙˆØ¯ (Ù…Ø«Ù„ Alert.mm) ÙÙ„Ø§ ÙŠØªÙˆÙ‚Ù Ø§Ù„Ø¨Ù†Ø§Ø¡
          
          cat <<'EOF' > Makefile
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64 arm64e
          THEOS_PACKAGE_SCHEME = rootless

          include $(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          # Ø¬Ù…Ø¹ ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          UEDumper_FILES = $(wildcard *.xm) $(wildcard *.mm) \
                           $(wildcard src/*.cpp) $(wildcard src/*.mm) \
                           $(wildcard src/*/*.cpp) $(wildcard src/*/*.mm) \
                           $(wildcard src/*/*/*.cpp) $(wildcard src/*/*/*.mm) \
                           $(wildcard deps/KittyMemory/*.cpp)

          UEDumper_FRAMEWORKS = UIKit Foundation Security

          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ±Ø¬Ù…
          UEDumper_CFLAGS = -fobjc-arc -Wno-error -Wno-deprecated-declarations -Wno-unused-variable
          UEDumper_CCFLAGS = -std=c++17 -I. -Ideps/KittyMemory -Isrc

          include $(THEOS_MAKE_PATH)/tweak.mk
          EOF
          
          echo "âœ… New Makefile created successfully."

      # ------------------------------------------------------------------
      # 5. ØªÙ†ØµÙŠØ¨ Theos (Ù…Ø¹ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© SDK)
      # ------------------------------------------------------------------
      - name: 5) Setup Theos Clean
        shell: bash
        run: |
          rm -rf $HOME/theos
          git clone --recursive --depth=1 https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH

          # Ø­Ø°Ù Ù…Ø¬Ù„Ø¯ SDKs Ø§Ù„ÙØ§Ø±Øº Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£
          rm -rf $HOME/theos/sdks
          git clone --depth=1 https://github.com/theos/sdks.git $HOME/theos/sdks
          
          # Ø­Ø°Ù Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
          rm -rf $HOME/theos/sdks/iPhoneOS{9..13}.sdk
          
          brew install ldid xz

      # ------------------------------------------------------------------
      # 6. Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      # ------------------------------------------------------------------
      - name: 6) Build Package
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          
          echo "ğŸš€ Building..."
          make clean || true
          
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless

      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Final_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
