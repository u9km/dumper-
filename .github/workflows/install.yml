name: Final Fix (Mac Sed + SDK + Paths)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. ÙÙƒ Ø¶ØºØ· ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
      - name: 1) Unzip All Files
        shell: bash
        run: |
          set -e
          echo "ğŸ“¦ Unzipping all zip files..."
          rm -rf _extract
          mkdir -p _extract

          find . -maxdepth 1 -name "*.zip" -exec unzip -o -q {} -d _extract \;

          echo "âœ… Extracted files tree:"
          find _extract -maxdepth 2 -type d

      # 2. ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      - name: 2) Locate Project Root
        shell: bash
        run: |
          MAKEFILE_PATH=$(find _extract -name "Makefile" | head -n 1)

          if [ -z "$MAKEFILE_PATH" ]; then
            echo "âŒ Error: Makefile not found!"
            exit 1
          fi

          PROJECT_ROOT=$(dirname "$MAKEFILE_PATH")
          echo "âœ… Project Root: $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV

      # 3. Ø¥ØµÙ„Ø§Ø­ KittyMemory
      - name: 3) Fix KittyMemory
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          mkdir -p deps

          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙƒÙˆÙƒØ©
          KITTY_FILE=$(find ../.. -name "KittyInclude.hpp" | head -n 1)

          if [ -n "$KITTY_FILE" ]; then
            echo "âœ… Found KittyInclude at: $KITTY_FILE"
            KITTY_DIR=$(dirname "$KITTY_FILE")
            
            # Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ ÙØ±Ø¹ÙŠ Ø§Ø³Ù…Ù‡ KittyMemory
            if [[ $(basename "$KITTY_DIR") == "KittyMemory" ]]; then
               # Ù†Ù†Ø³Ø® Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø£Ø¨ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ©
               CP_SOURCE="$KITTY_DIR"
            else
               CP_SOURCE="$KITTY_DIR"
            fi
            
            rm -rf deps/KittyMemory
            mkdir -p deps/KittyMemory
            cp -R "$CP_SOURCE/" deps/KittyMemory/
            
            echo "KITTY_PATH=$PROJECT_ROOT/deps/KittyMemory" >> $GITHUB_ENV
          else
            echo "âš ï¸ Not found, cloning from git..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
            echo "KITTY_PATH=$PROJECT_ROOT/deps/KittyMemory" >> $GITHUB_ENV
          fi

      # 4. Ø¥ØµÙ„Ø§Ø­ Makefile (ØªÙ… ØªØµØ­ÙŠØ­ Ø£Ù…Ø± sed Ù„Ù„Ù…Ø§Ùƒ)
      - name: 4) Fix Makefile Source
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          
          # Ø¥Ø°Ø§ ÙƒØ§Ù† Makefile ÙŠØ·Ù„Ø¨ UEDumper.mm ÙˆÙ‡Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
          if grep -q "UEDumper.mm" Makefile && [ ! -f "UEDumper.mm" ]; then
            echo "âš ï¸ UEDumper.mm referenced but missing!"
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¨Ø¯ÙŠÙ„ (Tweak.mm Ø£Ùˆ src/Tweak.mm)
            ALT_FILE=$(find . -name "Tweak.mm" -o -name "Tweak.xm" | head -n 1 | sed 's|^\./||')
            
            if [ -n "$ALT_FILE" ]; then
              echo "ğŸ”§ Patching Makefile: Replacing UEDumper.mm with $ALT_FILE"
              
              # --- Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… -i '' Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ macOS ---
              sed -i '' "s|UEDumper.mm|$ALT_FILE|g" Makefile
              
              echo "âœ… Makefile patched successfully."
              grep "_FILES" Makefile
            else
              echo "âŒ Critical: No source file found!"
              exit 1
            fi
          fi

      # 5. ØªÙ†ØµÙŠØ¨ Theos (Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ SDK)
      - name: 5) Setup Theos Clean
        shell: bash
        run: |
          rm -rf $HOME/theos
          git clone --recursive --depth=1 https://github.com/theos/theos.git $HOME/theos
          
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH

          # Ø­Ø°Ù SDKs Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£
          rm -rf $HOME/theos/sdks
          git clone --depth=1 https://github.com/theos/sdks.git $HOME/theos/sdks
          rm -rf $HOME/theos/sdks/iPhoneOS{9..13}.sdk
          
          brew install ldid xz

      # 6. Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: 6) Build Package
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          
          echo "ğŸš€ Building..."
          make clean || true
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ¶Ù…ÙŠÙ† Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© 'file not found'
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="-I$KITTY_PATH -I$PROJECT_ROOT/deps" \
            ADDITIONAL_CCFLAGS="-I$KITTY_PATH -I$PROJECT_ROOT/deps"

      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Fixed_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
