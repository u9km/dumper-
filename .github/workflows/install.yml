name: Build From 4 Zips (Ultimate)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1. Unzip ALL 4 Files
        run: |
          # ÙÙƒ Ø¶ØºØ· ÙƒÙ„ Ù…Ù„ÙØ§Øª Zip Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø§Ø³Ù…Ù‡Ø§
          echo "ğŸ“¦ Unzipping all archives..."
          for file in *.zip; do
            if [ -f "$file" ]; then
              echo "--> Unzipping $file"
              # -o ØªØ¹Ù†ÙŠ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª (Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª)
              unzip -o -q "$file"
            fi
          done

      - name: 2. Locate & Fix Project Structure
        run: |
          # Ø£ÙŠÙ† Ù‡Ùˆ Ù…Ù„Ù MakefileØŸ (Ø¬Ø°Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹)
          echo "ğŸ” Searching for Makefile..."
          MAKEFILE_PATH=$(find . -name "Makefile" -not -path "*/theos/*" | head -n 1)
          
          if [ -z "$MAKEFILE_PATH" ]; then
            echo "âŒ ERROR: Makefile not found in any zip!"
            exit 1
          fi
          
          PROJECT_ROOT=$(dirname "$MAKEFILE_PATH")
          echo "âœ… Project Root: $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV
          
          # Ø£ÙŠÙ† Ù‡Ùˆ Ù…Ù„Ù KittyInclude.hppØŸ (Ø¬Ø°Ø± Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©)
          echo "ğŸ” Searching for KittyMemory..."
          KITTY_FILE=$(find . -name "KittyInclude.hpp" | head -n 1)
          
          if [ -n "$KITTY_FILE" ]; then
             # Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠ Ù„Ù„Ù…Ù„Ù
             KITTY_DIR=$(dirname "$KITTY_FILE")
             
             # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ø³Ù…Ù‡ KittyMemoryØŒ Ù†Ø£Ø®Ø°Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ
             # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø¢Ø®Ø±ØŒ Ù†Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
             if [[ $(basename "$KITTY_DIR") == "KittyMemory" ]]; then
                SOURCE_DIR="$KITTY_DIR"
             else
                # Ø­Ø§Ù„Ø© Ù†Ø§Ø¯Ø±Ø©: Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø£Ø¨
                SOURCE_DIR="$KITTY_DIR"
             fi
             
             echo "âœ… Found KittyMemory at: $SOURCE_DIR"
             
             # Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ deps/KittyMemory
             DEST_DIR="$PROJECT_ROOT/deps/KittyMemory"
             
             # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø©
             mkdir -p "$PROJECT_ROOT/deps"
             
             # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ÙÙŠ Ù…ÙƒØ§Ù†Ù‡Ø§ Ø§Ù„ØµØ­ÙŠØ­
             if [ "$(readlink -f "$SOURCE_DIR")" != "$(readlink -f "$DEST_DIR")" ]; then
                echo "ğŸšš Moving KittyMemory to $DEST_DIR"
                rm -rf "$DEST_DIR"
                cp -r "$SOURCE_DIR" "$DEST_DIR"
             fi
          else
             echo "âš ï¸ KittyMemory not found! Cloning fallback..."
             mkdir -p "$PROJECT_ROOT/deps"
             git clone https://github.com/MJx0/KittyMemory.git "$PROJECT_ROOT/deps/KittyMemory"
          fi

      - name: 3. Setup Theos (Reset & Install)
        run: |
          # ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ ØªØ«Ø¨ÙŠØª Ø³Ø§Ø¨Ù‚ Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ "already exists"
          rm -rf $HOME/theos
          
          # ØªØ«Ø¨ÙŠØª Ø¬Ø¯ÙŠØ¯ ÙˆÙ†Ø¸ÙŠÙ
          git clone --recursive --depth=1 https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH
          
          # ØªØ­Ù…ÙŠÙ„ SDKs
          git clone --depth=1 https://github.com/theos/sdks.git $HOME/theos/sdks
          # Ø­Ø°Ù SDKs Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø­Ø¬Ù…
          rm -rf $HOME/theos/sdks/iPhoneOS{9..13}.sdk
          
          brew install ldid xz

      - name: 4. Force Build (Include Fix)
        run: |
          cd ${{ env.PROJECT_ROOT }}
          
          echo "ğŸ”§ Patching Build Environment..."
          # Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± KittyMemory Ø¥Ù„Ù‰ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Theos Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹
          # Ù‡Ø°Ø§ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© file not found 100%
          export THEOS_INCLUDE_PATH="$PWD/deps/KittyMemory"
          export CFLAGS="$CFLAGS -I$PWD/deps/KittyMemory"
          export CXXFLAGS="$CXXFLAGS -I$PWD/deps/KittyMemory"
          
          echo "ğŸš€ Building..."
          make clean || true
          
          # ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø£Ù…Ø± Ø§Ù„Ù€ make
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="-I$PWD/deps/KittyMemory" \
            ADDITIONAL_CCFLAGS="-I$PWD/deps/KittyMemory"

      - name: 5. Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Final_Build
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
