name: Build From Zips (Deep Scan + Fix Includes)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1) Unzip ALL zip files (deep/recursive) + show paths
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p _extract
          echo "ğŸ“¦ Searching for zip files in repo..."
          find . -type f -name "*.zip" -print

          echo "ğŸ“¦ Extracting all top-level zips into _extract/ ..."
          while IFS= read -r z; do
            echo "==> unzip: $z"
            unzip -o -q "$z" -d _extract
          done < <(find . -type f -name "*.zip" -print)

          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙŠ zip Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (nested zips) Ø¨Ø´ÙƒÙ„ ØªÙƒØ±Ø§Ø±ÙŠ
          echo "ğŸ” Checking for nested zips inside _extract/ ..."
          pass=0
          while true; do
            nested_count="$(find _extract -type f -name "*.zip" | wc -l | tr -d ' ')"
            if [ "$nested_count" = "0" ]; then
              break
            fi
            pass=$((pass+1))
            echo "ğŸ” Pass #$pass: found $nested_count nested zip(s). Extracting..."
            while IFS= read -r nz; do
              echo "   ==> unzip nested: $nz"
              nz_dir="$(dirname "$nz")"
              unzip -o -q "$nz" -d "$nz_dir"
              rm -f "$nz"
            done < <(find _extract -type f -name "*.zip" -print)
          done

          echo "âœ… Extraction done."
          echo "ğŸ“‚ Top tree (depth 5):"
          find _extract -maxdepth 5 -print

      - name: 2) Locate Project Root (Makefile) + locate deps (KittyMemory/fmt) + export paths
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ” Searching for Makefile inside _extract/ ..."
          MAKEFILE_PATH="$(find _extract -type f -name Makefile -not -path "*/theos/*" | head -n 1 || true)"
          if [ -z "${MAKEFILE_PATH:-}" ]; then
            echo "âŒ ERROR: Makefile not found anywhere inside extracted zips."
            echo "Tip: ØªØ£ÙƒØ¯ Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙØ¹Ù„Ø§Ù‹ ÙŠØ­ØªÙˆÙŠ Makefile Ø¶Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©."
            exit 1
          fi

          PROJECT_ROOT="$(cd "$(dirname "$MAKEFILE_PATH")" && pwd)"
          echo "âœ… PROJECT_ROOT=$PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo "ğŸ” Searching for KittyInclude.hpp ..."
          KITTY_HEADER="$(find _extract -type f -name "KittyInclude.hpp" | head -n 1 || true)"
          if [ -n "${KITTY_HEADER:-}" ]; then
            # ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ù…Ø³Ø§Ø± ÙŠÙƒÙˆÙ† .../KittyMemory/KittyInclude.hpp
            KITTY_DIR="$(cd "$(dirname "$KITTY_HEADER")" && pwd)"
            echo "âœ… Found KittyInclude.hpp at: $KITTY_HEADER"
            echo "âœ… Kitty dir: $KITTY_DIR"
          else
            echo "âš ï¸ KittyInclude.hpp not found in zips. Will clone KittyMemory."
            KITTY_DIR=""
          fi

          # Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø«Ø¨Øª Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù„ÙŠ Theos Ø±Ø§Ø­ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡
          mkdir -p "$PROJECT_ROOT/deps"

          if [ -n "${KITTY_DIR:-}" ]; then
            # Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ KittyMemory Ø£Ùˆ Ø¯Ø§Ø®Ù„ includeâ€¦ Ù†Ø±ÙØ¹ Ù„Ù„Ø£Ø¨ Ø¥Ø°Ø§ Ù„Ø²Ù…
            # Ù‡Ø¯ÙÙ†Ø§ ÙŠÙƒÙˆÙ†: deps/KittyMemory ÙŠØ­ØªÙˆÙŠ KittyInclude.hpp Ø¯Ø§Ø®Ù„Ù‡Ø§ Ø£Ùˆ Ø¯Ø§Ø®Ù„ subfolder ÙˆØ§Ø¶Ø­
            echo "ğŸ“Œ Copy KittyMemory into PROJECT_ROOT/deps/KittyMemory"
            rm -rf "$PROJECT_ROOT/deps/KittyMemory"
            # Ø¥Ø°Ø§ KittyInclude.hpp Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø§Ø³Ù…Ù‡ KittyMemory Ù…Ù…ØªØ§Ø²ØŒ ØºÙŠØ±Ù‡ Ø§Ù†Ø³Ø® Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù„Ù Ù†ÙØ³Ù‡
            base="$(basename "$KITTY_DIR")"
            if [ "$base" = "KittyMemory" ]; then
              cp -R "$KITTY_DIR" "$PROJECT_ROOT/deps/KittyMemory"
            else
              # Ø§Ù†Ø³Ø® Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠ Ù„Ù„Ù…Ù„Ù ÙƒØ­Ù„ Ø¹Ø§Ù…
              cp -R "$KITTY_DIR" "$PROJECT_ROOT/deps/KittyMemory"
            fi
          else
            echo "ğŸŒ Cloning KittyMemory..."
            rm -rf "$PROJECT_ROOT/deps/KittyMemory"
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git "$PROJECT_ROOT/deps/KittyMemory"
          fi

          echo "ğŸ” Searching for fmt/format.h ..."
          FMT_HEADER="$(find _extract -type f -path "*/fmt/format.h" | head -n 1 || true)"
          if [ -n "${FMT_HEADER:-}" ]; then
            # include path ÙŠÙƒÙˆÙ† Ø§Ù„Ø£Ø¨ Ø§Ù„Ù„ÙŠ ÙŠØ­ØªÙˆÙŠ Ù…Ø¬Ù„Ø¯ fmt
            FMT_INCLUDE="$(cd "$(dirname "$(dirname "$FMT_HEADER")")" && pwd)"
            echo "âœ… Found fmt headers in zips at: $FMT_HEADER"
            echo "âœ… FMT_INCLUDE=$FMT_INCLUDE"
            echo "FMT_INCLUDE=$FMT_INCLUDE" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ fmt headers not found in zips; will install via brew later."
            echo "FMT_INCLUDE=" >> "$GITHUB_ENV"
          fi

          echo "ğŸ“Œ Final deps layout:"
          find "$PROJECT_ROOT/deps" -maxdepth 5 -print || true

      - name: 3) Setup Theos (clean) + FIX sdks conflict + install tools
        shell: bash
        run: |
          set -euo pipefail

          rm -rf "$HOME/theos"
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          # Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© sdks already exists
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          # ØªØ®ÙÙŠÙ Ø§Ù„Ø­Ø¬Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          rm -rf "$HOME/theos/sdks/iPhoneOS"{9..13}".sdk" || true

          brew update
          brew install ldid xz fmt

          # Ø§Ø­ØµÙ„ include path Ù„Ù„Ù€ fmt Ù…Ù† brew
          FMT_PREFIX="$(brew --prefix fmt)"
          echo "âœ… brew fmt prefix: $FMT_PREFIX"
          echo "BREW_FMT_INCLUDE=$FMT_PREFIX/include" >> "$GITHUB_ENV"

      - name: 4) Build (force include paths for KittyMemory + fmt)
        shell: bash
        run: |
          set -euo pipefail

          cd "$PROJECT_ROOT"

          # Ù…Ø³Ø§Ø±Ø§Øª include
          KITTY_INC_1="$PROJECT_ROOT/deps/KittyMemory"
          KITTY_INC_2="$PROJECT_ROOT/deps/KittyMemory/include"
          KITTY_INC_3="$PROJECT_ROOT/deps/KittyMemory/KittyMemory"

          # fmt include: ÙŠØ§ Ù…Ù† zips ÙŠØ§ Ù…Ù† brew
          if [ -n "${FMT_INCLUDE:-}" ]; then
            FMT_INC="$FMT_INCLUDE"
          else
            FMT_INC="${BREW_FMT_INCLUDE:-}"
          fi

          echo "âœ… Using include paths:"
          echo "  - KITTY: $KITTY_INC_1"
          echo "  - KITTY2: $KITTY_INC_2"
          echo "  - KITTY3: $KITTY_INC_3"
          echo "  - FMT:   $FMT_INC"

          # Ù†Ø¶ÙŠÙ ÙƒÙ„ Ù…Ø³Ø§Ø±Ø§Øª Kitty Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ø£Ù† Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ØªØ®ØªÙ„Ù Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù„ÙØ§Øª
          ADD_INC="-I$KITTY_INC_1 -I$KITTY_INC_2 -I$KITTY_INC_3"
          if [ -n "${FMT_INC:-}" ]; then
            ADD_INC="$ADD_INC -I$FMT_INC"
          fi

          make clean || true

          # Ù…Ù‡Ù…: Ù†Ù…Ø±Ø±Ù‡Ø§ ÙƒÙ€ ADDITIONAL_CFLAGS/CCFLAGS Ø¹Ø´Ø§Ù† ØªÙˆØµÙ„ Ù„Ù„Ù€ clang
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="$ADD_INC" \
            ADDITIONAL_CCFLAGS="$ADD_INC" \
            ADDITIONAL_CXXFLAGS="$ADD_INC"

      - name: 5) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: Build_DEB
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
            ${{ env.PROJECT_ROOT }}/packages/*.ddeb
          if-no-files-found: error
