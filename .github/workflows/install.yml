name: Ultimate Build (Auto-Gen Makefile)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. ÙÙƒ Ø¶ØºØ· ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
      - name: 1) Unzip All Files
        shell: bash
        run: |
          set -e
          echo "ğŸ“¦ Unzipping all zip files..."
          rm -rf _extract
          mkdir -p _extract

          find . -maxdepth 1 -name "*.zip" -exec unzip -o -q {} -d _extract \;

          echo "âœ… Extracted files tree:"
          find _extract -maxdepth 2 -type d

      # 2. ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      - name: 2) Locate Project Root
        shell: bash
        run: |
          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù„Ù ÙƒÙˆØ¯ Ù…ØµØ¯Ø±ÙŠ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Makefile Ø§Ù„Ù…ÙƒØ³ÙˆØ±
          # Ù†Ø¨Ø­Ø« Ø¹Ù† Tweak.mm Ø£Ùˆ Main.cpp
          SRC_FILE=$(find _extract -name "Tweak.mm" -o -name "Tweak.xm" -o -name "Dumper.cpp" | head -n 1)

          if [ -z "$SRC_FILE" ]; then
            echo "âŒ Error: No source code found!"
            exit 1
          fi

          PROJECT_ROOT=$(dirname "$SRC_FILE")
          # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ srcØŒ Ù†Ø¹ÙˆØ¯ Ø®Ø·ÙˆØ© Ù„Ù„ÙˆØ±Ø§Ø¡
          if [[ $(basename "$PROJECT_ROOT") == "src" ]]; then
            PROJECT_ROOT=$(dirname "$PROJECT_ROOT")
          fi

          echo "âœ… Project Root: $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV

      # 3. Ø¥ØµÙ„Ø§Ø­ KittyMemory
      - name: 3) Fix KittyMemory
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          mkdir -p deps

          KITTY_FILE=$(find ../.. -name "KittyInclude.hpp" | head -n 1)

          if [ -n "$KITTY_FILE" ]; then
            echo "âœ… Found KittyInclude at: $KITTY_FILE"
            KITTY_DIR=$(dirname "$KITTY_FILE")
            if [[ $(basename "$KITTY_DIR") == "KittyMemory" ]]; then
               CP_SOURCE="$KITTY_DIR"
            else
               CP_SOURCE="$KITTY_DIR"
            fi
            rm -rf deps/KittyMemory
            mkdir -p deps/KittyMemory
            cp -R "$CP_SOURCE/" deps/KittyMemory/
            echo "KITTY_PATH=$PROJECT_ROOT/deps/KittyMemory" >> $GITHUB_ENV
          else
            echo "âš ï¸ Not found, cloning from git..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
            echo "KITTY_PATH=$PROJECT_ROOT/deps/KittyMemory" >> $GITHUB_ENV
          fi

      # 4. Ø¥Ù†Ø´Ø§Ø¡ Makefile Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ)
      - name: 4) Generate Fresh Makefile
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          
          echo "ğŸ—‘ï¸ Deleting old broken Makefile..."
          rm -f Makefile

          echo "ğŸ†• Generating smart Makefile..."
          # Ù†ÙƒØªØ¨ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ÙŠØ³ØªØ®Ø¯Ù… wildcard Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙ‚Ø·
          # Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ø®Ø·Ø£ "File not found" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
          
          cat <<'EOF' > Makefile
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64 arm64e
          THEOS_PACKAGE_SCHEME = rootless

          include $(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø³ÙˆØ§Ø¡ ÙÙŠ Ø§Ù„Ø¬Ø°Ø± Ø£Ùˆ ÙÙŠ src)
          UEDumper_FILES = $(wildcard *.xm) $(wildcard *.mm) \
                           $(wildcard src/*.cpp) $(wildcard src/*.mm) \
                           $(wildcard src/*/*.cpp) $(wildcard src/*/*.mm) \
                           $(wildcard src/*/*/*.cpp) $(wildcard src/*/*/*.mm) \
                           $(wildcard deps/KittyMemory/*.cpp)

          UEDumper_FRAMEWORKS = UIKit Foundation Security

          UEDumper_CFLAGS = -fobjc-arc -Wno-error -Wno-deprecated-declarations -Wno-unused-variable
          UEDumper_CCFLAGS = -std=c++17 -I. -Ideps/KittyMemory -Isrc

          include $(THEOS_MAKE_PATH)/tweak.mk
          EOF
          
          echo "âœ… Makefile created:"
          cat Makefile

      # 5. ØªÙ†ØµÙŠØ¨ Theos
      - name: 5) Setup Theos Clean
        shell: bash
        run: |
          rm -rf $HOME/theos
          git clone --recursive --depth=1 https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH

          rm -rf $HOME/theos/sdks
          git clone --depth=1 https://github.com/theos/sdks.git $HOME/theos/sdks
          rm -rf $HOME/theos/sdks/iPhoneOS{9..13}.sdk
          
          brew install ldid xz

      # 6. Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: 6) Build Package
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          
          echo "ğŸš€ Building..."
          make clean || true
          
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless
            
      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Fixed_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
