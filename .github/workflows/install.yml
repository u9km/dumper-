name: Build From All Zips (Auto Locate + Fix)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1) Unzip ALL zip files (recursive) + show paths
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ“¦ Searching for zip files..."
          mapfile -d '' ZIPS < <(find . -type f -name "*.zip" -print0)

          if [ "${#ZIPS[@]}" -eq 0 ]; then
            echo "âš ï¸ No zip files found in repository."
          else
            echo "âœ… Found ${#ZIPS[@]} zip(s):"
            printf ' - %s\n' "${ZIPS[@]}"
          fi

          echo "ğŸ“‚ Unzipping all archives (merge/overwrite)..."
          for z in "${ZIPS[@]}"; do
            echo "--> Unzipping: $z"
            unzip -o -q "$z"
          done

          echo "ğŸ” After unzip: showing top-level structure"
          ls -la

      - name: 2) Locate Project Root (Makefile) + locate deps paths
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ” Searching for Makefile (excluding theos if exists)..."
          MAKEFILE_PATH="$(find . -type f -name "Makefile" -not -path "*/theos/*" | head -n 1 || true)"

          if [ -z "${MAKEFILE_PATH}" ]; then
            echo "âŒ ERROR: Makefile not found after unzipping."
            echo "Tip: ØªØ£ÙƒØ¯ Ø¥Ù† Ø£Ø­Ø¯ Ø§Ù„Ù€ zips ÙŠØ­ØªÙˆÙŠ Ù…Ø´Ø±ÙˆØ¹ Theos tweak ÙˆÙÙŠÙ‡ Makefile."
            exit 1
          fi

          PROJECT_ROOT="$(cd "$(dirname "$MAKEFILE_PATH")" && pwd)"
          echo "âœ… PROJECT_ROOT=$PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo "ğŸ” Searching for KittyInclude.hpp (KittyMemory)..."
          KITTY_FILE="$(find . -type f -name "KittyInclude.hpp" | head -n 1 || true)"
          if [ -n "${KITTY_FILE}" ]; then
            KITTY_DIR="$(cd "$(dirname "$KITTY_FILE")" && pwd)"
            echo "âœ… Found KittyMemory header at: $KITTY_FILE"
            echo "âœ… Using source dir: $KITTY_DIR"

            mkdir -p "$PROJECT_ROOT/deps"
            DEST_DIR="$PROJECT_ROOT/deps/KittyMemory"

            # Ù„Ùˆ Ù‡ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù† Ù„Ø§ ØªÙ†Ø³Ø®
            if [ "$KITTY_DIR" != "$DEST_DIR" ]; then
              echo "ğŸšš Copying KittyMemory to: $DEST_DIR"
              rm -rf "$DEST_DIR"
              mkdir -p "$DEST_DIR"
              cp -R "$KITTY_DIR"/. "$DEST_DIR"/
            else
              echo "â„¹ï¸ KittyMemory already in correct place."
            fi
          else
            echo "âš ï¸ KittyMemory not found in extracted files. Cloning fallback..."
            mkdir -p "$PROJECT_ROOT/deps"
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git "$PROJECT_ROOT/deps/KittyMemory"
          fi

          echo "ğŸ“Œ Quick path check:"
          echo "PROJECT_ROOT => $PROJECT_ROOT"
          echo "KittyMemory   => $PROJECT_ROOT/deps/KittyMemory"
          ls -la "$PROJECT_ROOT" || true
          ls -la "$PROJECT_ROOT/deps" || true

      - name: 3) Setup Theos (clean) + FIX sdks conflict
        shell: bash
        run: |
          set -euo pipefail

          # ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØµÙŠØ± ØªØ¹Ø§Ø±Ø¶Ø§Øª
          rm -rf "$HOME/theos"

          echo "â¬‡ï¸ Cloning Theos..."
          # IMPORTANT: Ù„Ø§ ØªØ¹Ù…Ù„ clone Ù„Ù„Ù€ sdks Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ theos Ø¬Ø§Ø¨Ù‡Ø§ ÙƒÙ€ submodule
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          # ØªØ£ÙƒØ¯ Ø£Ù† sdks Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø¬Ø§Ø¡Øª Ù…Ø¹ --recursive ØºØ§Ù„Ø¨Ø§Ù‹)
          if [ -d "$HOME/theos/sdks" ] && [ "$(ls -A "$HOME/theos/sdks" | wc -l | tr -d ' ')" -gt 0 ]; then
            echo "âœ… sdks already present via submodule: $HOME/theos/sdks"
          else
            echo "âš ï¸ sdks missing/empty. Cloning sdks..."
            rm -rf "$HOME/theos/sdks"
            git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"
          fi

          # ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          rm -rf "$HOME/theos/sdks/iPhoneOS"9*.sdk "$HOME/theos/sdks/iPhoneOS1"0*.sdk \
                 "$HOME/theos/sdks/iPhoneOS1"1*.sdk "$HOME/theos/sdks/iPhoneOS1"2*.sdk \
                 "$HOME/theos/sdks/iPhoneOS1"3*.sdk || true

          echo "ğŸº Installing build deps..."
          brew update
          brew install ldid xz || true

      - name: 4) Build (force include paths)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ğŸ”§ Ensuring KittyMemory include path..."
          export THEOS_INCLUDE_PATH="$PWD/deps/KittyMemory"
          export CFLAGS="${CFLAGS:-} -I$PWD/deps/KittyMemory"
          export CXXFLAGS="${CXXFLAGS:-} -I$PWD/deps/KittyMemory"

          echo "ğŸ§¹ Clean..."
          make clean || true

          echo "ğŸš€ Build package..."
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="-I$PWD/deps/KittyMemory" \
            ADDITIONAL_CCFLAGS="-I$PWD/deps/KittyMemory"

          echo "ğŸ“¦ Built packages:"
          ls -la "$PROJECT_ROOT/packages" || true

      - name: 5) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: Build_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
          if-no-files-found: error
