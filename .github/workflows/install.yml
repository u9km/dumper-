name: Build From Zips (Correct Root Detection)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 1) Extract ALL zip files
        shell: bash
        run: |
          set -e
          mkdir extracted

          echo "ðŸ“¦ Extracting ZIP files..."
          for z in *.zip; do
            echo "âž¡ï¸ $z"
            unzip -o -q "$z" -d extracted/
          done

          echo "ðŸ“‚ Extracted tree:"
          find extracted -maxdepth 4 -type d

      - name: 2) Locate REAL project root (Makefile)
        shell: bash
        run: |
          set -e

          MAKEFILE_PATH=$(find extracted -name Makefile | head -n 1)

          if [ -z "$MAKEFILE_PATH" ]; then
            echo "âŒ Makefile not found in extracted zips"
            exit 1
          fi

          PROJECT_ROOT=$(dirname "$MAKEFILE_PATH")
          echo "âœ… PROJECT_ROOT=$PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV

          echo "ðŸ“ Project root contents:"
          ls -la "$PROJECT_ROOT"

      - name: 3) Setup Theos (clean)
        shell: bash
        run: |
          rm -rf $HOME/theos
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          git clone https://github.com/theos/sdks.git $HOME/theos/sdks

          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH

          brew install ldid xz fmt || true

      - name: 4) Build from correct directory
        shell: bash
        run: |
          cd "$PROJECT_ROOT"

          echo "ðŸš€ Building from:"
          pwd

          make clean || true
          make package FINALPACKAGE=1 messages=yes

      - name: 5) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
