name: Build From 4 Zips (Auto-Find Everything)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1) Unzip ALL zip files (recursive) + show paths
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ“¦ Searching for zip files..."
          mkdir -p _extract

          # Ø¨Ø¯ÙˆÙ† mapfile (Ù„Ø£Ù† macOS bash Ù‚Ø¯ÙŠÙ…)
          found_any=0
          while IFS= read -r zip; do
            found_any=1
            echo "â¡ï¸ Unzipping: $zip"
            # Ù†ÙÙƒ Ø¯Ø§Ø®Ù„ _extract ÙˆÙ†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¯Ù…Ø¬ ÙˆØ§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
            unzip -o -q "$zip" -d _extract
          done < <(find . -type f -name "*.zip" -maxdepth 2 -print)

          if [[ "$found_any" -eq 0 ]]; then
            echo "âŒ No zip files found in repo root."
            exit 1
          fi

          echo "âœ… Extract done."
          echo "ğŸ“‚ Top extracted folders:"
          ls -la _extract || true

          echo "ğŸ” Quick scan (first 200 entries):"
          (cd _extract && find . -maxdepth 5 -print | head -n 200) || true

      - name: 2) Locate Project Root (Makefile) + locate deps paths (KittyMemory & fmt)
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ” Finding Makefile (project root)..."
          MAKEFILE_PATH="$(find _extract -type f -name "Makefile" | head -n 1 || true)"
          if [[ -z "${MAKEFILE_PATH}" ]]; then
            echo "âŒ ERROR: Makefile not found inside extracted content."
            echo "ğŸ§ª Listing Makefile-like:"
            find _extract -maxdepth 6 -iname "*makefile*" -print | head -n 50 || true
            exit 1
          fi

          PROJECT_ROOT="$(cd "$(dirname "$MAKEFILE_PATH")" && pwd)"
          echo "âœ… PROJECT_ROOT: $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo "ğŸ” Finding KittyInclude.hpp (KittyMemory)..."
          KITTY_HEADER="$(find _extract -type f -name "KittyInclude.hpp" | head -n 1 || true)"

          mkdir -p "$PROJECT_ROOT/deps"

          if [[ -n "${KITTY_HEADER}" ]]; then
            KITTY_DIR="$(cd "$(dirname "$KITTY_HEADER")" && pwd)"
            # Ø¥Ø°Ø§ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¯Ø§Ø®Ù„ include/ ÙØ§Ù„Ø¬Ø°Ø± ÙŠÙƒÙˆÙ† Ø£Ø¨ÙˆÙ‡
            if [[ "$(basename "$KITTY_DIR")" == "include" ]]; then
              KITTY_ROOT="$(cd "$KITTY_DIR/.." && pwd)"
            else
              KITTY_ROOT="$KITTY_DIR"
            fi

            echo "âœ… Found KittyMemory root: $KITTY_ROOT"
            echo "KITTY_ROOT=$KITTY_ROOT" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ KittyInclude.hpp not found in zips. Will clone fallback."
            echo "KITTY_ROOT=" >> "$GITHUB_ENV"
          fi

          echo "ğŸ” Finding fmt/format.h..."
          FMT_HEADER="$(find _extract -type f -path "*/fmt/format.h" | head -n 1 || true)"

          if [[ -n "${FMT_HEADER}" ]]; then
            # ØºØ§Ù„Ø¨Ø§Ù‹ ÙŠÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ include/fmt/format.h
            FMT_DIR="$(cd "$(dirname "$FMT_HEADER")" && pwd)"         # .../fmt
            FMT_INCLUDE="$(cd "$FMT_DIR/.." && pwd)"                  # .../include
            echo "âœ… Found fmt include dir: $FMT_INCLUDE"
            echo "FMT_INCLUDE=$FMT_INCLUDE" >> "$GITHUB_ENV"
          else
            echo "âš ï¸ fmt/format.h not found in zips. Will clone fallback."
            echo "FMT_INCLUDE=" >> "$GITHUB_ENV"
          fi

      - name: 3) Prepare deps (copy from extracted or clone fallbacks)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ env.PROJECT_ROOT }}"

          mkdir -p deps

          # KittyMemory
          if [[ -n "${{ env.KITTY_ROOT }}" ]] && [[ -d "${{ env.KITTY_ROOT }}" ]]; then
            echo "ğŸšš Copy KittyMemory into PROJECT_ROOT/deps/KittyMemory"
            rm -rf deps/KittyMemory
            cp -R "${{ env.KITTY_ROOT }}" deps/KittyMemory
          else
            echo "â¬‡ï¸ Cloning KittyMemory fallback..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          fi

          # fmt
          if [[ -n "${{ env.FMT_INCLUDE }}" ]] && [[ -d "${{ env.FMT_INCLUDE }}" ]]; then
            echo "ğŸšš Copy fmt include into PROJECT_ROOT/deps/fmt/include"
            rm -rf deps/fmt
            mkdir -p deps/fmt
            cp -R "${{ env.FMT_INCLUDE }}" deps/fmt/include
          else
            echo "â¬‡ï¸ Cloning fmt fallback..."
            rm -rf deps/fmt
            git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt
            # include Ø³ÙŠÙƒÙˆÙ† deps/fmt/include
          fi

          echo "âœ… deps ready:"
          ls -la deps || true
          echo "âœ… KittyMemory check:"
          find deps/KittyMemory -maxdepth 4 -name "KittyInclude.hpp" -print | head -n 5 || true
          echo "âœ… fmt check:"
          ls -la deps/fmt/include/fmt/format.h || true

      - name: 4) Setup Theos (clean) + FIX sdks conflict
        shell: bash
        run: |
          set -euo pipefail

          # ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ exists
          rm -rf "$HOME/theos"

          echo "â¬‡ï¸ Cloning Theos..."
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          # Ù…Ù‡Ù…: Ø§Ø­Ø°Ù sdks Ù‚Ø¨Ù„ clone Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ø·Ø£
          rm -rf "$HOME/theos/sdks"

          echo "â¬‡ï¸ Cloning SDKs..."
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          # ØªØ®ÙÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          rm -rf "$HOME/theos/sdks/iPhoneOS"{9..13}.sdk || true

          brew update
          brew install ldid xz || true

      - name: 5) Build (auto include paths for KittyMemory + fmt)
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ env.PROJECT_ROOT }}"

          # Ù…Ø³Ø§Ø±Ø§Øª include Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
          KITTY_INC="$PWD/deps/KittyMemory"
          # Ø¥Ø°Ø§ KittyMemory ÙÙŠÙ‡Ø§ include/ Ù†Ø¶ÙŠÙÙ‡Ø§ Ø£ÙŠØ¶Ø§Ù‹
          KITTY_INC2="$PWD/deps/KittyMemory/include"

          FMT_INC="$PWD/deps/fmt/include"

          echo "ğŸ”§ Using include paths:"
          echo "  KITTY_INC=$KITTY_INC"
          echo "  KITTY_INC2=$KITTY_INC2"
          echo "  FMT_INC=$FMT_INC"

          # Ø­Ù‚Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (C/C++)
          export CFLAGS="${CFLAGS:-} -I$KITTY_INC -I$KITTY_INC2 -I$FMT_INC"
          export CXXFLAGS="${CXXFLAGS:-} -I$KITTY_INC -I$KITTY_INC2 -I$FMT_INC"
          export THEOS_INCLUDE_PATH="$KITTY_INC:$KITTY_INC2:$FMT_INC"

          make clean || true

          echo "ğŸš€ Building package..."
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="-I$KITTY_INC -I$KITTY_INC2 -I$FMT_INC" \
            ADDITIONAL_CCFLAGS="-I$KITTY_INC -I$KITTY_INC2 -I$FMT_INC"

      - name: 6) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Final_Build
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
