name: Ultimate Auto-Build

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1. Unzip & Organize
        run: |
          # ÙÙƒ Ø¶ØºØ· ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
          for file in *.zip; do
            [ -f "$file" ] && unzip -o "$file"
          done

          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Makefile Ù„ØªØ­Ø¯ÙŠØ¯ Ø¬Ø°Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          MAKEFILE_PATH=$(find . -name "Makefile" -not -path "*/theos/*" | head -n 1)
          if [ -z "$MAKEFILE_PATH" ]; then
            echo "âŒ Error: Makefile not found!"
            exit 1
          fi
          PROJECT_ROOT=$(dirname "$MAKEFILE_PATH")
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV
          
          # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù„Ù„ØªØ£ÙƒØ¯
          echo "ğŸ“ Project Root is: $PROJECT_ROOT"
          
          # --- Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© KittyMemory (Ø§Ù„Ø°ÙƒØ§Ø¡ Ù‡Ù†Ø§) ---
          # 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬Ù„Ø¯ KittyMemory Ø£ÙŠÙ†Ù…Ø§ ÙƒØ§Ù†
          KITTY_PATH=$(find . -type d -name "KittyMemory" | head -n 1)
          
          if [ -n "$KITTY_PATH" ]; then
            echo "âœ… Found KittyMemory at: $KITTY_PATH"
            
            # 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ deps Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            mkdir -p "$PROJECT_ROOT/deps"
            
            # 3. Ù†Ù‚Ù„ KittyMemory Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ (deps/KittyMemory)
            # Ù†ØªØ£ÙƒØ¯ Ø£ÙˆÙ„Ø§Ù‹ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ù†Ù‚Ù„Ù‡ Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†
            if [ "$KITTY_PATH" != "$PROJECT_ROOT/deps/KittyMemory" ]; then
                rm -rf "$PROJECT_ROOT/deps/KittyMemory"
                mv "$KITTY_PATH" "$PROJECT_ROOT/deps/"
            fi
          else
             echo "âš ï¸ KittyMemory folder not found in zips! Cloning from git..."
             git clone https://github.com/MJx0/KittyMemory.git "$PROJECT_ROOT/deps/KittyMemory"
          fi

      - name: 2. Auto-Fix Makefile
        run: |
          cd ${{ env.PROJECT_ROOT }}
          
          # Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ¹Ø¯Ù„ Makefile Ù„ÙŠØ¶ÙŠÙ Ù…Ø³Ø§Ø±Ø§Øª KittyMemory Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹
          # Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„ÙŠÙ‡Ø§ØŒ Ø³Ù†Ø¶ÙŠÙÙ‡Ø§.
          
          echo "ğŸ”§ Patching Makefile to include KittyMemory..."
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„ØªØ¶Ù…ÙŠÙ† (Include Path)
          if ! grep -q "deps/KittyMemory" Makefile; then
             # Ø¥Ø¶Ø§ÙØ© KittyMemory Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¬Ù…ÙŠØ¹Ù‡Ø§
             sed -i '' 's|_FILES =|_FILES = deps/KittyMemory/*.cpp |' Makefile
             # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± (Header Search Path) Ù„ÙŠØ¬Ø¯ KittyInclude.hpp
             sed -i '' 's|_CCFLAGS =|_CCFLAGS = -Ideps/KittyMemory -I. |' Makefile
          fi
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø± Ø§Ù„ØªØ¶Ù…ÙŠÙ† Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­
          export THEOS_INCLUDE_PATH="-Ideps/KittyMemory"

      - name: 3. Setup Theos (Clean Install)
        run: |
          # ØªÙ†ØµÙŠØ¨ Theos
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH
          
          # --- Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© SDK (Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø³Ø¨Ù‚) ---
          rm -rf $HOME/theos/sdks
          git clone https://github.com/theos/sdks.git $HOME/theos/sdks
          
          # ØªÙ†Ø¸ÙŠÙ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
          rm -rf $HOME/theos/sdks/iPhoneOS{9,10,11,12,13}.sdk
          
          brew install ldid xz

      - name: 4. Build Tweak
        run: |
          cd ${{ env.PROJECT_ROOT }}
          make clean || true
          
          # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©)
          make package FINALPACKAGE=1 messages=yes

      - name: 5. Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Fixed
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
