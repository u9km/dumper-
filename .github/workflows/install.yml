name: Build From All Zips (Auto Locate + Fix Paths)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install unzip (safety)
        run: |
          set -e
          brew install unzip || true

      - name: 1) Unzip ALL zip files (recursive) + show paths
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ“¦ Searching for zip files..."
          # Ù†ÙƒØ±Ø± ÙÙƒ Ø§Ù„Ø¶ØºØ· Ù„Ø£Ù† Ø¨Ø¹Ø¶ zips ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ zips
          for round in 1 2 3 4 5; do
            echo "---- Round $round ----"
            FOUND=0

            # find -print0 Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
            while IFS= read -r -d '' z; do
              FOUND=1
              echo "â¡ï¸ Unzipping: $z"
              unzip -o -q "$z" -d "$(dirname "$z")"
            done < <(find . -type f -name "*.zip" -print0)

            if [ "$FOUND" -eq 0 ]; then
              echo "âœ… No more zips found."
              break
            fi
          done

          echo ""
          echo "ğŸ§­ Top-level structure:"
          ls -la

          echo ""
          echo "ğŸ§¾ Showing important files (Makefile / Tweak.xm / *.mm / *.cpp / KittyInclude.hpp):"
          find . -maxdepth 6 \( \
            -name "Makefile" -o -name "Tweak.xm" -o -name "*.mm" -o -name "*.cpp" -o -name "KittyInclude.hpp" \
          \) -print

      - name: 2) Locate Project Root (Makefile) + locate deps paths
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ” Locating Makefile (project root)..."
          # -print -quit Ø¨Ø¯Ù„ head Ù„ØªØ¬Ù†Ø¨ Broken pipe Ù…Ø¹ pipefail
          MAKEFILE_PATH="$(find . -type f -name "Makefile" -not -path "*/theos/*" -print -quit || true)"

          if [ -z "${MAKEFILE_PATH}" ]; then
            echo "âŒ ERROR: Makefile not found after unzipping."
            exit 1
          fi

          PROJECT_ROOT="$(cd "$(dirname "$MAKEFILE_PATH")" && pwd)"
          echo "âœ… PROJECT_ROOT = $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo ""
          echo "ğŸ“Œ Listing project root content:"
          ls -la "$PROJECT_ROOT"

          echo ""
          echo "ğŸ” Searching for KittyInclude.hpp..."
          KITTY_HDR="$(find . -type f -name "KittyInclude.hpp" -print -quit || true)"
          if [ -n "$KITTY_HDR" ]; then
            echo "âœ… Found KittyInclude.hpp at: $KITTY_HDR"
          else
            echo "âš ï¸ KittyInclude.hpp NOT found in extracted files (we will clone KittyMemory)."
          fi

      - name: 3) Setup Theos (clean) + FIX sdks conflict
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ§¹ Cleaning old theos (avoid 'already exists')..."
          rm -rf "$HOME/theos"

          echo "â¬‡ï¸ Cloning theos..."
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          echo "ğŸ§¹ Cleaning old sdks then cloning..."
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          echo "ğŸ§½ Removing very old SDKs to reduce size..."
          rm -rf "$HOME/theos/sdks/iPhoneOS9.0.sdk"  || true
          rm -rf "$HOME/theos/sdks/iPhoneOS10.0.sdk" || true
          rm -rf "$HOME/theos/sdks/iPhoneOS11.0.sdk" || true
          rm -rf "$HOME/theos/sdks/iPhoneOS12.0.sdk" || true
          rm -rf "$HOME/theos/sdks/iPhoneOS13.0.sdk" || true

          echo "ğŸ”§ Installing build deps..."
          brew install ldid xz || true

      - name: 4) Ensure KittyMemory exists + force include paths + Build
        shell: bash
        run: |
          set -euo pipefail

          cd "${PROJECT_ROOT}"

          echo "ğŸ“¦ Ensuring deps/KittyMemory..."
          mkdir -p deps

          # 1) Ø­Ø§ÙˆÙ„ Ù†Ù„Ø§Ù‚ÙŠ KittyMemory Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙŠ Ø§ØªÙÙƒ
          FOUND_KITTY_DIR=""
          if find .. -type f -name "KittyInclude.hpp" -print -quit | grep -q .; then
            KITTY_HDR="$(find .. -type f -name "KittyInclude.hpp" -print -quit)"
            FOUND_KITTY_DIR="$(cd "$(dirname "$KITTY_HDR")" && pwd)"
            echo "âœ… Kitty header dir found: $FOUND_KITTY_DIR"
          fi

          # 2) Ù„Ùˆ Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§Ù‡Ø§ØŒ Ù†Ø¹Ù…Ù„ clone
          if [ -z "$FOUND_KITTY_DIR" ]; then
            echo "â¬‡ï¸ Cloning KittyMemory (fallback)..."
            rm -rf "deps/KittyMemory"
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git "deps/KittyMemory"
          else
            # Ù„Ùˆ Ù„Ù‚ÙŠØªÙ‡Ø§ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±ØŒ Ø§Ù†Ø³Ø®Ù‡Ø§ Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
            echo "ğŸšš Copying KittyMemory into deps/KittyMemory..."
            rm -rf "deps/KittyMemory"
            mkdir -p "deps/KittyMemory"
            cp -R "$FOUND_KITTY_DIR/." "deps/KittyMemory/" || true
          fi

          echo ""
          echo "ğŸ§¾ Verifying KittyInclude.hpp location after fix:"
          find "deps/KittyMemory" -type f -name "KittyInclude.hpp" -print || true

          echo ""
          echo "ğŸ”§ Setting include flags..."
          # Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ø­ØªÙ…Ø§Ù„ Ù„Ø£Ù† Ø¨Ø¹Ø¶ Ø§Ù„Ø±ÙŠØ¨Ùˆ ÙŠÙƒÙˆÙ† Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¯Ø§Ø®Ù„ subfolder
          INC1="$PWD/deps/KittyMemory"
          INC2="$PWD/deps/KittyMemory/KittyMemory"
          export THEOS_INCLUDE_PATH="$INC1:$INC2"
          export CFLAGS="${CFLAGS:-} -I$INC1 -I$INC2"
          export CXXFLAGS="${CXXFLAGS:-} -I$INC1 -I$INC2"

          echo ""
          echo "ğŸš€ Building..."
          make clean || true

          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="-I$INC1 -I$INC2" \
            ADDITIONAL_CCFLAGS="-I$INC1 -I$INC2"

      - name: 5) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: Final_Build_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
