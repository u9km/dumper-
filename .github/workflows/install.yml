name: Build Fixed (SDK + Makefile + Kitty)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------------
      # 1. ÙÙƒ Ø¶ØºØ· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¯Ù…Ø¬Ù‡Ø§ ÙÙŠ Ù…Ø¬Ù„Ø¯ ÙˆØ§Ø­Ø¯
      # ------------------------------------------------------------------
      - name: 1) Unzip All Files
        shell: bash
        run: |
          set -e
          echo "ğŸ“¦ Unzipping all zip files..."
          rm -rf _extract
          mkdir -p _extract

          # ÙÙƒ Ø¶ØºØ· ÙƒÙ„ Ù…Ù„Ù zip Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù„Ø¯ _extract
          find . -maxdepth 1 -name "*.zip" -exec unzip -o -q {} -d _extract \;

          echo "âœ… Extracted files tree (Level 2):"
          find _extract -maxdepth 2 -type d
          
      # ------------------------------------------------------------------
      # 2. ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Makefile)
      # ------------------------------------------------------------------
      - name: 2) Locate Project Root
        shell: bash
        run: |
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Makefile
          MAKEFILE_PATH=$(find _extract -name "Makefile" | head -n 1)

          if [ -z "$MAKEFILE_PATH" ]; then
            echo "âŒ Error: Makefile not found!"
            exit 1
          fi

          PROJECT_ROOT=$(dirname "$MAKEFILE_PATH")
          echo "âœ… Project Root: $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV

      # ------------------------------------------------------------------
      # 3. Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© KittyInclude.hpp (Ù†Ù‚Ù„Ù‡Ø§ Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­)
      # ------------------------------------------------------------------
      - name: 3) Fix KittyMemory
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          mkdir -p deps

          echo "ğŸ” Searching for KittyInclude.hpp..."
          KITTY_FILE=$(find ../.. -name "KittyInclude.hpp" | head -n 1)

          if [ -n "$KITTY_FILE" ]; then
            echo "âœ… Found at: $KITTY_FILE"
            # Ù†Ø£Ø®Ø° Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù
            KITTY_DIR=$(dirname "$KITTY_FILE")
            
            # Ù†Ù†Ù‚Ù„ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¥Ù„Ù‰ deps/KittyMemory
            rm -rf deps/KittyMemory
            mkdir -p deps/KittyMemory
            cp -R "$KITTY_DIR/" deps/KittyMemory/
            
            # Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù„Ù…ØªØ±Ø¬Ù…
            echo "KITTY_PATH=$PROJECT_ROOT/deps/KittyMemory" >> $GITHUB_ENV
          else
            echo "âš ï¸ Not found, cloning from git..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
            echo "KITTY_PATH=$PROJECT_ROOT/deps/KittyMemory" >> $GITHUB_ENV
          fi

      # ------------------------------------------------------------------
      # 4. Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© UEDumper.mm (ØªØ¹Ø¯ÙŠÙ„ Makefile ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
      # ------------------------------------------------------------------
      - name: 4) Fix Makefile Source (UEDumper.mm error)
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù…Ù„Ù UEDumper.mm Ù…ÙÙ‚ÙˆØ¯ØŸ
          if grep -q "UEDumper.mm" Makefile && [ ! -f "UEDumper.mm" ]; then
            echo "âš ï¸ UEDumper.mm referenced but missing!"
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø¯ÙŠÙ„ (Tweak.mm Ø£Ùˆ Tweak.xm)
            ALT_FILE=$(find . -maxdepth 2 -name "Tweak.mm" -o -name "Tweak.xm" | head -n 1 | sed 's|^\./||')
            
            if [ -n "$ALT_FILE" ]; then
              echo "ğŸ”§ Patching Makefile: Replacing UEDumper.mm with $ALT_FILE"
              sed -i "s/UEDumper.mm/$ALT_FILE/g" Makefile
            else
              echo "âŒ Critical: No source file (Tweak.mm/xm) found!"
              exit 1
            fi
          fi

      # ------------------------------------------------------------------
      # 5. ØªÙ†ØµÙŠØ¨ Theos (Ù…Ø¹ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© SDK already exists)
      # ------------------------------------------------------------------
      - name: 5) Setup Theos Clean
        shell: bash
        run: |
          rm -rf $HOME/theos
          git clone --recursive --depth=1 https://github.com/theos/theos.git $HOME/theos
          
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH

          # ğŸ”¥ Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ Ù„Ø®Ø·Ø£ SDK (Exit 128)
          rm -rf $HOME/theos/sdks
          git clone --depth=1 https://github.com/theos/sdks.git $HOME/theos/sdks
          
          # Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„
          rm -rf $HOME/theos/sdks/iPhoneOS{9..13}.sdk
          
          brew install ldid xz

      # ------------------------------------------------------------------
      # 6. Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      # ------------------------------------------------------------------
      - name: 6) Build Package
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          
          echo "ğŸš€ Building..."
          make clean || true
          
          # ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© 'file not found'
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="-I$KITTY_PATH -I$PROJECT_ROOT/deps" \
            ADDITIONAL_CCFLAGS="-I$KITTY_PATH -I$PROJECT_ROOT/deps"

      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Fixed_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
