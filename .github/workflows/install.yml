name: Build From Zips (Auto Extract + Auto Paths + Fix Kitty + Fix fmt)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: 1) Unzip ALL zip files (recursive) + show full paths
        run: |
          set -euo pipefail

          echo "üîé Searching for zip files (recursive)..."
          ZIP_LIST="$(find . -type f -name '*.zip' -print | sort || true)"

          if [[ -z "${ZIP_LIST}" ]]; then
            echo "‚ùå No zip files found in repository."
            echo "üí° Put your zips in repo root or any folder, and push again."
            exit 1
          fi

          echo "‚úÖ Found these ZIPs:"
          echo "${ZIP_LIST}"

          echo "üì¶ Extracting all ZIPs into: $GITHUB_WORKSPACE/_extract"
          mkdir -p "$GITHUB_WORKSPACE/_extract"

          # unzip ŸÉŸÑ zip ÿØÿßÿÆŸÑ ŸÖÿ¨ŸÑÿØ ÿÆÿßÿµ ÿ®Ÿá (ŸÑÿ™ÿ¨ŸÜÿ® ÿ™ÿØÿßÿÆŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™)
          while IFS= read -r z; do
            [[ -f "$z" ]] || continue
            base="$(basename "$z" .zip)"
            out="$GITHUB_WORKSPACE/_extract/$base"
            mkdir -p "$out"
            echo "‚û°Ô∏è Unzipping: $z  -->  $out"
            unzip -o -q "$z" -d "$out"
          done <<< "${ZIP_LIST}"

          echo "üßæ Showing extracted tree (top 300 lines):"
          (cd "$GITHUB_WORKSPACE/_extract" && find . -print | sed -n '1,300p')

          echo "üìå Full path base: $GITHUB_WORKSPACE/_extract"

      - name: 2) Locate Project Root (Makefile) + detect Kitty + detect fmt + export paths
        run: |
          set -euo pipefail

          echo "üîç Locating Makefile inside extracted content..."
          MAKEFILE_PATH="$(find "$GITHUB_WORKSPACE/_extract" -type f -name 'Makefile' | head -n 1 || true)"

          if [[ -z "${MAKEFILE_PATH}" ]]; then
            echo "‚ùå ERROR: Makefile not found inside extracted zips."
            echo "üí° Ensure one of your ZIPs contains the Theos project with a Makefile."
            exit 1
          fi

          PROJECT_ROOT="$(dirname "$MAKEFILE_PATH")"
          echo "‚úÖ PROJECT_ROOT = $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo ""
          echo "üîç Searching for KittyInclude.hpp..."
          KITTY_HDR="$(find "$GITHUB_WORKSPACE/_extract" -type f -name 'KittyInclude.hpp' | head -n 1 || true)"
          if [[ -n "${KITTY_HDR}" ]]; then
            KITTY_INC_DIR="$(dirname "$KITTY_HDR")"
            echo "‚úÖ Found KittyInclude.hpp at: $KITTY_HDR"
            echo "‚úÖ KITTY_INC_DIR = $KITTY_INC_DIR"
            echo "KITTY_INC_DIR=$KITTY_INC_DIR" >> "$GITHUB_ENV"
          else
            echo "‚ö†Ô∏è KittyInclude.hpp NOT found in zips."
            echo "KITTY_INC_DIR=" >> "$GITHUB_ENV"
          fi

          echo ""
          echo "üîç Searching for fmt/format.h..."
          FMT_HDR="$(find "$GITHUB_WORKSPACE/_extract" -type f -path '*/fmt/format.h' | head -n 1 || true)"
          if [[ -n "${FMT_HDR}" ]]; then
            # include path ŸÑÿßÿ≤ŸÖ ŸäŸÉŸàŸÜ ŸÇÿ®ŸÑ fmt/
            FMT_INC_DIR="$(dirname "$(dirname "$FMT_HDR")")"
            echo "‚úÖ Found fmt/format.h at: $FMT_HDR"
            echo "‚úÖ FMT_INC_DIR = $FMT_INC_DIR"
            echo "FMT_INC_DIR=$FMT_INC_DIR" >> "$GITHUB_ENV"
          else
            echo "‚ö†Ô∏è fmt/format.h NOT found in zips (will install via brew)."
            echo "FMT_INC_DIR=" >> "$GITHUB_ENV"
          fi

          echo ""
          echo "üßæ Quick scan important files (first 200 matches):"
          find "$PROJECT_ROOT" -maxdepth 5 -type f \( -name "*.xm" -o -name "*.mm" -o -name "*.m" -o -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "Makefile" \) \
            -print | sed -n '1,200p'

      - name: 3) Setup Theos (clean) + fix sdks conflict + install deps (ldid/xz/fmt)
        run: |
          set -euo pipefail

          echo "üßπ Cleaning old theos to avoid 'already exists'..."
          rm -rf "$HOME/theos"

          echo "‚¨áÔ∏è Cloning Theos..."
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "‚¨áÔ∏è Cloning Theos SDKs..."
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          echo "‚úÖ THEOS ready at $HOME/theos"
          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          echo "üç∫ Installing build tools..."
          brew update
          brew install ldid xz

          # fmt: ÿßÿ∞ÿß ŸÖÿß ŸÑŸÇŸäŸÜÿßŸáÿß ÿØÿßÿÆŸÑ zips ŸÜÿ´ÿ®ÿ™Ÿáÿß
          if [[ -z "${FMT_INC_DIR:-}" ]]; then
            echo "üç∫ Installing fmt via brew..."
            brew install fmt
            FMT_BREW_PREFIX="$(brew --prefix fmt)"
            echo "‚úÖ fmt prefix: $FMT_BREW_PREFIX"
            echo "FMT_BREW_PREFIX=$FMT_BREW_PREFIX" >> "$GITHUB_ENV"
          fi

      - name: 4) Build (force include paths for Kitty + fmt) + package
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "üìç Building in: $PWD"
          echo "THEOS=$THEOS"

          # ==== Kitty include flags ====
          KITTY_FLAGS=""
          if [[ -n "${KITTY_INC_DIR:-}" ]]; then
            # ÿ£ÿ≠ŸäÿßŸÜŸãÿß Ÿäÿ≠ÿ™ÿßÿ¨ parent ÿ£Ÿäÿ∂Ÿãÿß
            KITTY_PARENT="$(dirname "$KITTY_INC_DIR")"
            KITTY_FLAGS="-I${KITTY_INC_DIR} -I${KITTY_PARENT}"
            echo "‚úÖ Using Kitty flags: $KITTY_FLAGS"
          else
            echo "‚ö†Ô∏è Kitty not found in zips. (If your code includes <KittyInclude.hpp>, build may fail.)"
          fi

          # ==== fmt include flags ====
          FMT_FLAGS=""
          if [[ -n "${FMT_INC_DIR:-}" ]]; then
            FMT_FLAGS="-I${FMT_INC_DIR}"
            echo "‚úÖ Using fmt from zips: $FMT_FLAGS"
          else
            # fmt from brew
            FMT_FLAGS="-I${FMT_BREW_PREFIX}/include"
            echo "‚úÖ Using fmt from brew: $FMT_FLAGS"
          fi

          # ŸÜÿ¨ŸÖÿπ ŸÉŸÑ ÿßŸÑŸÄ flags
          ALL_INC_FLAGS="$KITTY_FLAGS $FMT_FLAGS"

          echo "üîß Applying include flags to build..."
          export CFLAGS="${CFLAGS:-} $ALL_INC_FLAGS"
          export CXXFLAGS="${CXXFLAGS:-} $ALL_INC_FLAGS"
          export THEOS_INCLUDE_PATH="$PWD"

          echo "üßπ make clean..."
          make clean || true

          echo "üöÄ make package..."
          make package FINALPACKAGE=1 messages=yes \
            THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="$ALL_INC_FLAGS" \
            ADDITIONAL_CCFLAGS="$ALL_INC_FLAGS"

          echo "‚úÖ Build finished. Showing packages:"
          ls -la "$PROJECT_ROOT"/packages || true

      - name: 5) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: Build_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
