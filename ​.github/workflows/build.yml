name: Build All Zips (No-Jailbreak)

on:
  push:
    paths:
      - '**/*.zip'
  workflow_dispatch:

jobs:
  build:
    name: Extract All & Build
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Unzip ALL Files
        run: |
          echo "Finding and unzipping all zip files..."
          # هذا الأمر يفك ضغط كل الملفات الموجودة دفعة واحدة
          # الترتيب مهم: سيفك ضغطهم في نفس المكان ليتعرفوا على بعض
          for file in *.zip; do
            echo "Unzipping $file..."
            unzip -o "$file"
          done
          
          echo "Files in directory after unzip:"
          ls -R | grep ":$" | head -n 10 # طباعة للتأكد من الملفات

      - name: Locate Makefile
        id: locate
        run: |
          # البحث عن ملف Makefile في أي مكان (سواء داخل مجلد Tweak أو في الجذر)
          MAKEFILE_PATH=$(find . -name "Makefile" -not -path "*/theos/*" | head -n 1)
          
          if [ -z "$MAKEFILE_PATH" ]; then
            echo "::error::Makefile not found! Make sure one of your zips contains the source code."
            exit 1
          fi
          
          PROJECT_ROOT=$(dirname "$MAKEFILE_PATH")
          echo "Project root found at: $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV

      - name: Fix Dependencies (Merge deps)
        run: |
          # هذه الخطوة ذكية: إذا كان مجلد deps مفصولاً، سنحاول وضعه في المكان الصحيح
          # إذا وجدنا مجلد deps في الجذر، ومجلد المشروع في مكان آخر، ننقل deps للمشروع
          if [ -d "deps" ] && [ "${{ env.PROJECT_ROOT }}" != "." ]; then
             echo "Moving deps folder to project root..."
             cp -r deps "${{ env.PROJECT_ROOT }}/"
          fi

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH
          git clone https://github.com/theos/sdks.git $HOME/theos/sdks
          rm -rf $HOME/theos/sdks/*.sdk
          brew install ldid xz

      - name: Build Package
        run: |
          cd ${{ env.PROJECT_ROOT }}
          # تنظيف وبناء
          make clean
          make package FINALPACKAGE=1 messages=yes

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Final_Tweak
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
