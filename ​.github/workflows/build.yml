name: Build All Zips (Force Run)

on:
  push:
    branches: [ "main", "master" ] # سيعمل هذا الكود فوراً عند الحفظ
  workflow_dispatch:

jobs:
  build:
    name: Extract & Build
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Unzip ALL Files
        run: |
          echo "Finding and unzipping all zip files..."
          # يفك ضغط كل الملفات (Tweak, deps, scripts, main)
          for file in *.zip; do
            if [ -f "$file" ]; then
              echo "Unzipping $file..."
              unzip -o "$file"
            fi
          done

      - name: Locate Makefile
        id: locate
        run: |
          # يبحث عن Makefile في أي مكان
          MAKEFILE_PATH=$(find . -name "Makefile" -not -path "*/theos/*" | head -n 1)
          
          if [ -z "$MAKEFILE_PATH" ]; then
            echo "::error::Makefile not found! Check your zip files."
            exit 1
          fi
          
          PROJECT_ROOT=$(dirname "$MAKEFILE_PATH")
          echo "Project root found at: $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV

      - name: Fix Dependencies (Smart Move)
        run: |
          # ينقل مجلد deps إلى داخل مجلد المشروع إذا كانا منفصلين
          if [ -d "deps" ] && [ "${{ env.PROJECT_ROOT }}" != "." ]; then
             echo "Moving deps folder to project root..."
             cp -r deps "${{ env.PROJECT_ROOT }}/"
          fi

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH
          git clone https://github.com/theos/sdks.git $HOME/theos/sdks
          rm -rf $HOME/theos/sdks/*.sdk
          brew install ldid xz

      - name: Build Package
        run: |
          cd ${{ env.PROJECT_ROOT }}
          make clean || true
          # بناء النسخة النهائية
          make package FINALPACKAGE=1 messages=yes

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Final_Tweak
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
